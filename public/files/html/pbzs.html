<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç»ªåŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#818CF8',
                        neutral: '#1F2937',
                        light: '#F9FAFB',
                        accent: '#A5B4FC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .chat-height {
                height: calc(100vh - 12rem);
            }
            .user-message {
                @apply bg-primary text-white rounded-t-lg rounded-br-lg p-4 shadow-md;
            }
            .bot-message {
                @apply bg-light text-neutral rounded-t-lg rounded-bl-lg p-4 shadow-md;
            }
            .message-container {
                @apply flex items-start mb-4 max-w-3xl;
            }
            .typing-indicator {
                @apply inline-block h-2 w-2 rounded-full bg-primary/70 animate-pulse;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
    <div class="fixed top-4 left-4 z-10">
        <button onclick="goToDesktop()" class="bg-white hover:bg-gray-50 text-neutral/70 hover:text-neutral rounded-full p-3 shadow-lg transition-all duration-200 group">
            <i class="fa fa-home text-lg"></i>
            <span class="absolute left-full ml-2 top-1/2 transform -translate-y-1/2 bg-neutral text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">è¿”å›æ¡Œé¢</span>
        </button>
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-6 text-center">
            <h1 class="text-[rgba(59,130,246,0.7)] font-bold text-[clamp(1.8rem,5vw,2.5rem)] mb-2">æƒ…ç»ªåŠ©æ‰‹</h1>
            <p class="text-neutral/70 max-w-2xl mx-auto">ä¸€ä¸ªéšæ—¶å€¾å¬ä½ ã€å¸®åŠ©ä½ ç–å¯¼æƒ…ç»ªçš„æ™ºèƒ½ä¼™ä¼´</p>
            
            <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
            <div class="mt-3 mb-4">
                <div class="inline-flex items-center bg-white rounded-full px-4 py-2 shadow-sm">
                    <svg class="w-4 h-4 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span id="current-user-display" class="text-sm text-neutral/80">æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...</span>
                    <button onclick="clearCurrentUserChat()" class="ml-3 text-xs text-red-500 hover:text-red-400 transition-colors">
                        æ¸…é™¤è®°å½•
                    </button>
                </div>
            </div>
        </header>

        <div class="bg-bule-50 rounded-2xl shadow-xl overflow-hidden">
            <div id="chat-messages" class="chat-height overflow-y-auto p-6 space-y-6 bg-gradient-to-b from-white to-indigo-50">
                <div class="message-container justify-start">
                    <div class="bot-message">
                        <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯æƒ…ç»ªåŠ©æ‰‹ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ</p>
                        <p class="mt-2 text-sm text-neutral/60">æˆ‘åœ¨è¿™é‡Œå€¾å¬ä½ çš„æ„Ÿå—ï¼Œå¸®åŠ©ä½ ç–å¯¼æƒ…ç»ªã€‚</p>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200"></div>

            <div class="p-4 bg-white">
                <form id="message-form" class="flex items-center gap-3">
                    <textarea 
                        id="user-input" 
                        placeholder="è¾“å…¥ä½ çš„æ„Ÿå—..." 
                        class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none h-16 transition-all"
                        rows="1"></textarea>
                    <button 
                        type="submit" 
                        class="bg-primary hover:bg-primary/90 text-white rounded-lg p-3 transition-all flex items-center justify-center min-w-[60px]"
                    >
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <footer class="mt-8 text-center text-neutral/50 text-sm">
            <p>Â© 2025 æƒ…ç»ªåŠ©æ‰‹ | ä¿æŠ¤ä½ çš„æ¯ä¸€ä»½æƒ…ç»ª</p>
        </footer>
    </div>

<script>
window.goToDesktop = function() {
    // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œå°è¯•è·³è½¬åˆ°å¯èƒ½çš„æ¡Œé¢é¡µé¢
    window.location.href = "../../index.php";
};

// å…¨å±€å˜é‡
let currentUserId = null;
let currentUsername = null;
let chatMessages = null;
let userChatHistory = {}; // å­˜å‚¨å„ç”¨æˆ·çš„èŠå¤©è®°å½•

// APIé…ç½®
const API_URL = 'https://api.coze.cn/v3/chat';
const BOT_ID = '7489446781516857395'; 
const API_KEY = 'pat_lLCLYI0yYq4zQKtP3FfSCuWMbvL0zkbsi8iRTXJiDgwqnB0mWg8coEjvulcSSxic';

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
async function getCurrentUser() {
    try {
        const response = await fetch('../php/post_api.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=get_current_user'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.status === 'success') {
                currentUserId = result.user_id;
                currentUsername = result.username || `ç”¨æˆ·${currentUserId}`;
                updateUserDisplay();
                return true;
            }
        }
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
    
    // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ·ID
    currentUserId = 'default_user';
    currentUsername = 'è®¿å®¢ç”¨æˆ·';
    updateUserDisplay();
    return false;
}

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
function updateUserDisplay() {
    const userDisplay = document.getElementById('current-user-display');
    if (userDisplay) {
        if (currentUsername) {
            userDisplay.textContent = `å½“å‰ç”¨æˆ·: ${currentUsername}`;
        } else {
            userDisplay.textContent = 'æœªç™»å½•ç”¨æˆ·';
        }
    }
}

// ä¿å­˜èŠå¤©è®°å½•åˆ°localStorageï¼ˆæŒ‰ç”¨æˆ·éš”ç¦»ï¼‰
function saveChatHistory() {
    if (!currentUserId || !chatMessages) return;
    
    const messages = [];
    const messageElements = chatMessages.querySelectorAll('.message-container');
    
    messageElements.forEach(element => {
        const isUser = element.querySelector('.user-message');
        const contentElement = element.querySelector('.message-content');
        
        if (contentElement && contentElement.textContent) {
            messages.push({
                role: isUser ? 'user' : 'bot',
                content: contentElement.textContent.trim(),
                timestamp: Date.now()
            });
        }
    });
    
    // å°†æ¶ˆæ¯å­˜å‚¨åˆ°localStorage
    try {
        localStorage.setItem(`emotionChatHistory_${currentUserId}`, JSON.stringify(messages));
    } catch (e) {
        console.error('ä¿å­˜èŠå¤©è®°å½•åˆ°localStorageå¤±è´¥:', e);
    }
}

// åŠ è½½ç”¨æˆ·çš„èŠå¤©è®°å½•
function loadChatHistory() {
    if (!currentUserId || !chatMessages) return;
    
    try {
        const history = localStorage.getItem(`emotionChatHistory_${currentUserId}`);
        if (!history) return;
        
        const messages = JSON.parse(history);
        if (!Array.isArray(messages)) return;
        
        // æ¸…ç©ºå½“å‰æ˜¾ç¤ºï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
        const welcomeMessage = chatMessages.querySelector('.message-container');
        chatMessages.innerHTML = '';
        if (welcomeMessage) {
            chatMessages.appendChild(welcomeMessage);
        }
        
        // åŠ è½½è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
        messages.forEach(message => {
            if (message.role && message.content && message.role !== 'welcome') {
                addMessageToChat(message.role, message.content, false);
            }
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
    } catch (error) {
        console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
    }
}

// åˆ›å»ºæ¶ˆæ¯å®¹å™¨
function createMessageContainer(role) {
    const div = document.createElement('div');
    div.className = `message-container justify-${role === 'user' ? 'end' : 'start'} mb-4`;
    
    const messageClass = role === 'user' ? 'user-message' : 'bot-message';
    const maxWidth = 'max-w-[85%]';
    
    div.innerHTML = `
        <div class="${messageClass} p-4 rounded-lg shadow-md w-full ${maxWidth}">
            <div class="message-content"></div>
        </div>
    `;
    return div;
}

// æ·»åŠ ç”¨æˆ·/æœºå™¨äººæ¶ˆæ¯
function addMessageToChat(role, content, shouldSave = true) {
    if (!chatMessages) return;
    
    const div = createMessageContainer(role);
    const messageContent = div.querySelector('.message-content');
    
    if (messageContent) {
        messageContent.innerHTML = content
            .split('\n')
            .map(p => `<p>${p}</p>`)
            .join('');
    }
    
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ä¿å­˜èŠå¤©è®°å½•ï¼Œä½¿ç”¨å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
    if (shouldSave) {
        setTimeout(() => {
            saveChatHistory();
        }, 50);
    }
}

// è§£æSSEæ¶ˆæ¯
function parseSseMessage(msg) {
    const lines = msg.split('\n').filter(line => line.trim() !== '');
    let event = null;
    let data = {};
    for (const line of lines) {
        if (line.startsWith('event:')) {
            event = line.substring(6).trim();
        } else if (line.startsWith('data:')) {
            const dataStr = line.substring(5).trim();
            try {
                if (dataStr.startsWith('{') || dataStr.startsWith('[')) {
                    data = JSON.parse(dataStr);
                } else {
                    data = dataStr;
                }
            } catch (error) {
                console.error('è§£ææ•°æ®JSONå¤±è´¥:', error);
                data = dataStr;
            }
        }
    }
    
    return { event, data };
}

// å®æ—¶æ›´æ–°æµå¼æ˜¾ç¤º
function updateStreamDisplay(container, content) {
    container.innerHTML = content
        .split('\n')
        .map(p => `<p>${p}</p>`)
        .join('');
    
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// å¤„ç†æµå¼æ¶ˆæ¯
async function handleStreamResponse(response, container) {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullContent = '';
    let isCompleted = false;
    let lastAnswerContent = '';

    // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
    container.innerHTML = `
        <div class="flex items-center mb-4">
            <div class="typing-indicator-container">
                <span class="typing-indicator mr-1"></span>
                <span class="typing-indicator mx-1"></span>
                <span class="typing-indicator ml-1"></span>
            </div>
            <span class="ml-2 text-neutral/60">æ­£åœ¨æ€è€ƒ...</span>
        </div>
    `;

    try {
        while (!isCompleted) {
            const { done, value } = await reader.read();
            if (done) {
                isCompleted = true;
                break;
            }

            const chunk = decoder.decode(value, { stream: true });
            const messages = chunk.split('\n\n').filter(m => m.trim());

            for (const msg of messages) {
                if (msg.trim() === '') continue;
                
                const { event, data } = parseSseMessage(msg);
                
                if (event === 'conversation.message.stream') {
                    if (typeof data === 'string') {
                        fullContent += data;
                    } else if (data.delta) {
                        fullContent += data.delta;
                    }
                    
                    updateStreamDisplay(container, fullContent);
                } else if (event === 'conversation.message.completed') {
                    if (typeof data === 'string') {
                        try {
                            const parsedData = JSON.parse(data);
                            if (parsedData.type === 'answer') {
                                lastAnswerContent = parsedData.content || '';
                            }
                        } catch (e) {
                            console.error('è§£æå®Œæˆäº‹ä»¶æ•°æ®å¤±è´¥:', e);
                        }
                    } else if (data.type === 'answer') {
                        lastAnswerContent = data.content || '';
                    }
                }
            }
        }
    } catch (error) {
        console.error('å¤„ç†æµå¼å“åº”æ—¶å‡ºé”™:', error);
        isCompleted = true;
    }

    if (lastAnswerContent) {
        fullContent = lastAnswerContent;
        updateStreamDisplay(container, fullContent);
    }

    // ç§»é™¤æ€è€ƒçŠ¶æ€
    container.querySelectorAll('.typing-indicator-container').forEach(el => el.remove());
    if (!fullContent) {
        container.textContent = 'æŠ±æ­‰ï¼Œæœªè·å–åˆ°å›å¤ã€‚';
    }
    
    // ç¡®ä¿å†…å®¹å·²ç»æ›´æ–°åå†ä¿å­˜èŠå¤©è®°å½•
    setTimeout(() => {
        saveChatHistory();
    }, 100);
}

// å…¨å±€æ¸…é™¤å½“å‰ç”¨æˆ·èŠå¤©è®°å½•å‡½æ•°
window.clearCurrentUserChat = function() {
    if (!currentUserId) {
        alert('ç”¨æˆ·ä¿¡æ¯æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }
    
    if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        // æ¸…é™¤è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
        try {
            localStorage.removeItem(`emotionChatHistory_${currentUserId}`);
        } catch (e) {
            console.error('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥:', e);
        }
        
        // é‡ç½®èŠå¤©ç•Œé¢ï¼Œåªä¿ç•™æ¬¢è¿æ¶ˆæ¯
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="message-container justify-start">
                    <div class="bot-message">
                        <p>ğŸ‘‹ ${currentUsername}ï¼Œä½ å¥½ï¼æˆ‘æ˜¯æƒ…ç»ªåŠ©æ‰‹ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ</p>
                        <p class="mt-2 text-sm text-neutral/60">æˆ‘åœ¨è¿™é‡Œå€¾å¬ä½ çš„æ„Ÿå—ï¼Œå¸®åŠ©ä½ ç–å¯¼æƒ…ç»ªã€‚</p>
                    </div>
                </div>
            `;
        }
    }
};

document.addEventListener('DOMContentLoaded', async () => {
    const messageForm = document.getElementById('message-form');
    const userInput = document.getElementById('user-input');
    chatMessages = document.getElementById('chat-messages');
    
    // é¦–å…ˆè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    await getCurrentUser();
    
    // åŠ è½½è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
    loadChatHistory();
    
    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯æ˜¾ç¤ºç”¨æˆ·å
    const welcomeMessage = chatMessages.querySelector('.bot-message p');
    if (welcomeMessage && currentUsername) {
        welcomeMessage.textContent = `ğŸ‘‹ ${currentUsername}ï¼Œä½ å¥½ï¼æˆ‘æ˜¯æƒ…ç»ªåŠ©æ‰‹ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ`;
    }

    // å‘é€æ¶ˆæ¯
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addMessageToChat('user', message);
        userInput.value = '';

        // åˆ›å»ºæœºå™¨äººæ¶ˆæ¯å®¹å™¨
        const botMessageDiv = createMessageContainer('bot');
        const botResponseContainer = botMessageDiv.querySelector('.message-content');
        chatMessages.appendChild(botMessageDiv);

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bot_id: BOT_ID,
                    // ç¡®ä¿user_idæ˜¯å­—ç¬¦ä¸²æ ¼å¼ä¸”éç©º
                    user_id: currentUserId ? currentUserId.toString() : 'default_user',
                    stream: true,
                    auto_save_history: true,
                    additional_messages: [{
                        role: 'user',
                        content: message,
                        content_type: 'text'
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`APIé”™è¯¯: ${response.status} - ${response.statusText}`);
            }

            // å¤„ç†æµå¼å“åº”
            await handleStreamResponse(response, botResponseContainer);

        } catch (error) {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            botResponseContainer.innerHTML = `
                <div class="p-2 rounded bg-red-50 text-red-600 text-sm mb-2">
                    <i class="fa fa-exclamation-circle mr-1"></i> æŠ±æ­‰ï¼Œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯ï¼š${error.message}
                </div>
                <p>æ‚¨ä¹Ÿå¯ä»¥å°è¯•é‡æ–°æè¿°æ‚¨çš„æ„Ÿå—ã€‚</p>
            `;
            // å³ä½¿å‡ºé”™ä¹Ÿè¦ä¿å­˜èŠå¤©è®°å½•
            setTimeout(() => {
                saveChatHistory();
            }, 100);
        }
    });

    // æ”¯æŒEnteré”®å‘é€æ¶ˆæ¯
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
</body>
</html>