<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¿ƒç†è¯„ä¼°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">å¿ƒç†çŠ¶æ€è¯„ä¼°</h2>
            <p class="text-gray-600 mb-6">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œåˆ†ææ‚¨çš„å†å²å†…å®¹å¹¶è·å–å¿ƒç†çŠ¶æ€è¯„ä¼°</p>
            
            <button id="assessBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 flex items-center">
                <i class="fa fa-bar-chart mr-2"></i> è·å–è¯„ä¼°ç»“æœ
            </button>
        </div>

        <div id="resultSection" class="bg-white rounded-xl shadow-lg p-6 hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">è¯„ä¼°ç»“æœ</h3>
            <div id="loadingIndicator" class="text-center py-8 hidden">
                <i class="fa fa-circle-o-notch fa-spin text-blue-500 text-3xl"></i>
                <p class="text-gray-500 mt-2">æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</p>
            </div>
            <div id="resultContent" class="hidden">
                <div class="mb-4">
                    <h4 class="font-medium text-gray-700">å¿ƒç†è¯„åˆ†ï¼š<span id="score" class="text-blue-600"></span></h4>
                </div>
                <div id="analysis" class="space-y-3"></div>
            </div>
            <div id="errorMessage" class="text-red-500 hidden"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const assessBtn = document.getElementById('assessBtn');
            const resultSection = document.getElementById('resultSection');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultContent = document.getElementById('resultContent');
            const errorMessage = document.getElementById('errorMessage');
            const scoreElement = document.getElementById('score');
            const analysisElement = document.getElementById('analysis');

            assessBtn.addEventListener('click', function() {
                // æ˜¾ç¤ºç»“æœåŒºåŸŸå’ŒåŠ è½½æŒ‡ç¤ºå™¨
                resultSection.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');
                resultContent.classList.add('hidden');
                errorMessage.classList.add('hidden');
                assessBtn.disabled = true;
                assessBtn.classList.add('opacity-50', 'cursor-not-allowed');

                // ä½¿ç”¨POSTæ–¹å¼å‘é€è¯·æ±‚ï¼Œä¸pbzs.htmlä¿æŒä¸€è‡´
                const formData = new FormData();
                formData.append('action', 'get_assessment');

                fetch('../files/assessment.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('å“åº”çŠ¶æ€:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${response.status}`);
                    }
                    
                    return response.text().then(text => {
                        try {
                            if (text.trim() === '') {
                                throw new Error('æœåŠ¡å™¨è¿”å›ç©ºå†…å®¹');
                            }
                            
                            const data = JSON.parse(text);
                            return data;
                        } catch (err) {
                            console.error('æœåŠ¡å™¨è¿”å›éJSONæ ¼å¼:', text);
                            
                            const errorMatch = text.match(/<title>(.*?)<\/title>/i);
                            const errorMsg = errorMatch ? errorMatch[1] : 'æœåŠ¡å™¨è¿”å›æ ¼å¼é”™è¯¯';
                            
                            throw new Error(errorMsg);
                        }
                    });
                })
                .then(data => {
                    loadingIndicator.classList.add('hidden');
                    assessBtn.disabled = false;
                    assessBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    if (data.status === 'error') {
                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        errorMessage.innerHTML = `
                            <div class="text-red-600 font-medium mb-3">${data.message}</div>
                        `;
                        
                        // æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯
                        if (data.debug_info) {
                            const debugHtml = `
                                <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded">
                                    <h5 class="font-medium text-red-800 mb-2">è¯¦ç»†é”™è¯¯ä¿¡æ¯:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div><strong>CURLé”™è¯¯ç :</strong> ${data.debug_info.curl_errno || 'æ— '}</div>
                                        <div><strong>CURLé”™è¯¯:</strong> ${data.debug_info.curl_error || 'æ— '}</div>
                                        <div><strong>HTTPçŠ¶æ€ç :</strong> ${data.debug_info.http_code || 'æ— '}</div>
                                        <div><strong>å“åº”é•¿åº¦:</strong> ${data.debug_info.response_length || 0} å­—ç¬¦</div>
                                        <div><strong>API URL:</strong> ${data.debug_info.api_url || 'æ— '}</div>
                                        <div><strong>æ—¶é—´:</strong> ${data.debug_info.timestamp || 'æ— '}</div>
                                    </div>
                                    
                                    ${data.debug_info.user_data_summary ? `
                                        <div class="mt-3">
                                            <strong>ç”¨æˆ·æ•°æ®ç»Ÿè®¡:</strong>
                                            <div class="ml-4 text-sm">
                                                <div>è¯„è®ºæ•°é‡: ${data.debug_info.user_data_summary.comments_count}</div>
                                                <div>æƒ…ç»ªè®°å½•æ•°é‡: ${data.debug_info.user_data_summary.moods_count}</div>
                                                <div>å¸–å­æ•°é‡: ${data.debug_info.user_data_summary.posts_count}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.debug_info.prompt_sent ? `
                                        <div class="mt-3">
                                            <strong>å‘é€ç»™APIçš„Prompt:</strong>
                                            <pre class="mt-1 p-2 bg-gray-100 rounded text-xs overflow-x-auto max-h-40 overflow-y-auto">${data.debug_info.prompt_sent}</pre>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.debug_info.request_data ? `
                                        <div class="mt-3">
                                            <strong>è¯·æ±‚æ•°æ®:</strong>
                                            <pre class="mt-1 p-2 bg-gray-100 rounded text-xs overflow-x-auto max-h-40 overflow-y-auto">${JSON.stringify(data.debug_info.request_data, null, 2)}</pre>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.debug_info.response_raw ? `
                                        <div class="mt-3">
                                            <strong>åŸå§‹å“åº”:</strong>
                                            <pre class="mt-1 p-2 bg-gray-100 rounded text-xs overflow-x-auto max-h-40 overflow-y-auto">${data.debug_info.response_raw}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                            errorMessage.innerHTML += debugHtml;
                        }
                        
                        errorMessage.classList.remove('hidden');
                    } else if (data.status === 'success') {
                        // å¤„ç†è¯„ä¼°ç»“æœ
                        scoreElement.textContent = data.score || 'APIå“åº”';
                        
                        // æ˜¾ç¤ºåˆ†æå†…å®¹
                        analysisElement.innerHTML = '';
                        
                        // æ˜¾ç¤ºç”¨æˆ·æ•°æ®ç»Ÿè®¡
                        if (data.debug_info && data.debug_info.user_data_summary) {
                            const userDataDiv = document.createElement('div');
                            userDataDiv.className = 'mb-4 p-4 bg-purple-50 border border-purple-200 rounded';
                            userDataDiv.innerHTML = `
                                <h5 class="font-medium text-purple-800 mb-2">åˆ†æçš„ç”¨æˆ·æ•°æ®:</h5>
                                <div class="text-sm text-purple-700 space-y-1">
                                    <div>ğŸ“ è¯„è®ºæ•°é‡: ${data.debug_info.user_data_summary.comments_count}</div>
                                    <div>ğŸ˜Š æƒ…ç»ªè®°å½•æ•°é‡: ${data.debug_info.user_data_summary.moods_count}</div>
                                    <div>ğŸ“„ å¸–å­æ•°é‡: ${data.debug_info.user_data_summary.posts_count}</div>
                                </div>
                                
                                ${data.debug_info.user_data_summary.comments.length > 0 ? `
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-sm font-medium">æŸ¥çœ‹è¯„è®ºå†…å®¹</summary>
                                        <div class="mt-2 text-xs bg-white p-2 rounded border max-h-20 overflow-y-auto">
                                            ${data.debug_info.user_data_summary.comments.map(comment => `<div class="mb-1">â€¢ ${comment}</div>`).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                ${data.debug_info.user_data_summary.moods.length > 0 ? `
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-sm font-medium">æŸ¥çœ‹æƒ…ç»ªè®°å½•</summary>
                                        <div class="mt-2 text-xs bg-white p-2 rounded border max-h-20 overflow-y-auto">
                                            ${data.debug_info.user_data_summary.moods.map(mood => `<div class="mb-1">â€¢ [${mood.type}] ${mood.description}</div>`).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                ${data.debug_info.user_data_summary.posts.length > 0 ? `
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-sm font-medium">æŸ¥çœ‹å¸–å­å†…å®¹</summary>
                                        <div class="mt-2 text-xs bg-white p-2 rounded border max-h-20 overflow-y-auto">
                                            ${data.debug_info.user_data_summary.posts.map(post => `<div class="mb-1">â€¢ ${post.content} ${post.tags ? `[æ ‡ç­¾:${post.tags}]` : ''}</div>`).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                            `;
                            analysisElement.appendChild(userDataDiv);
                        }
                        
                        // æ˜¾ç¤ºå‘é€ç»™APIçš„Prompt
                        if (data.debug_info && data.debug_info.prompt_sent) {
                            const promptDiv = document.createElement('div');
                            promptDiv.className = 'mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded';
                            promptDiv.innerHTML = `
                                <h5 class="font-medium text-indigo-800 mb-2">å‘é€ç»™AIçš„å®Œæ•´Prompt:</h5>
                                <pre class="text-xs bg-white p-3 rounded border overflow-x-auto max-h-40 overflow-y-auto whitespace-pre-wrap">${data.debug_info.prompt_sent}</pre>
                            `;
                            analysisElement.appendChild(promptDiv);
                        }
                        
                        // æ˜¾ç¤ºAIåˆ†æç»“æœ
                        if (data.analysis && data.analysis !== 'æœªæ‰¾åˆ°æœ‰æ•ˆå†…å®¹') {
                            const analysisDiv = document.createElement('div');
                            analysisDiv.className = 'mb-4 p-4 bg-green-50 border border-green-200 rounded';
                            analysisDiv.innerHTML = `
                                <h5 class="font-medium text-green-800 mb-2">AIå¿ƒç†åˆ†æç»“æœ:</h5>
                                <div class="text-green-700 whitespace-pre-wrap">${data.analysis}</div>
                            `;
                            analysisElement.appendChild(analysisDiv);
                        }
                        
                        // æ˜¾ç¤ºå®Œæ•´çš„APIå“åº”
                        if (data.debug_info && data.debug_info.response_raw) {
                            const apiDiv = document.createElement('div');
                            apiDiv.className = 'mb-4 p-4 bg-gray-50 border border-gray-200 rounded';
                            apiDiv.innerHTML = `
                                <details>
                                    <summary class="cursor-pointer font-medium text-gray-800 mb-2">æŸ¥çœ‹SSEåŸå§‹å“åº”</summary>
                                    <pre class="text-xs bg-white p-3 rounded border overflow-x-auto max-h-60 overflow-y-auto mt-2">${data.debug_info.response_raw}</pre>
                                </details>
                            `;
                            analysisElement.appendChild(apiDiv);
                        }
                        
                        // æ˜¾ç¤ºSSEäº‹ä»¶ç¤ºä¾‹
                        if (data.sse_events_sample) {
                            const sseDiv = document.createElement('div');
                            sseDiv.className = 'mb-4 p-4 bg-orange-50 border border-orange-200 rounded';
                            sseDiv.innerHTML = `
                                <details>
                                    <summary class="cursor-pointer font-medium text-orange-800 mb-2">æŸ¥çœ‹SSEæµå¼äº‹ä»¶ç¤ºä¾‹</summary>
                                    <div class="mt-2 text-xs bg-white p-3 rounded border max-h-40 overflow-y-auto">
                                        ${data.sse_events_sample.map((event, index) => `
                                            <div class="mb-2 p-2 border rounded">
                                                <div><strong>äº‹ä»¶ ${index + 1}:</strong> ${event.event}</div>
                                                <div class="mt-1 text-gray-600">${event.data}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            `;
                            analysisElement.appendChild(sseDiv);
                        }
                        
                        // æ˜¾ç¤ºæŠ€æœ¯è°ƒè¯•ä¿¡æ¯
                        if (data.debug_info) {
                            const debugDiv = document.createElement('div');
                            debugDiv.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded';
                            debugDiv.innerHTML = `
                                <details>
                                    <summary class="cursor-pointer font-medium text-yellow-800 mb-2">æŸ¥çœ‹æŠ€æœ¯è°ƒè¯•ä¿¡æ¯</summary>
                                    <div class="space-y-2 text-sm mt-2">
                                        <div><strong>HTTPçŠ¶æ€ç :</strong> ${data.debug_info.http_code}</div>
                                        <div><strong>å“åº”é•¿åº¦:</strong> ${data.debug_info.response_length} å­—ç¬¦</div>
                                        <div><strong>æ—¶é—´:</strong> ${data.debug_info.timestamp}</div>
                                        <div><strong>æ‰§è¡Œæ­¥éª¤:</strong> ${data.debug_info.step}</div>
                                        <div><strong>æå–çš„å†…å®¹:</strong> ${data.extracted_content ? 'æ˜¯(' + data.extracted_content.length + 'å­—ç¬¦)' : 'å¦'}</div>
                                        <div><strong>SSEäº‹ä»¶æ•°é‡:</strong> ${data.debug_info.sse_events_count || 0}</div>
                                        <div><strong>æå–å†…å®¹é•¿åº¦:</strong> ${data.debug_info.extracted_content_length || 0} å­—ç¬¦</div>
                                        ${data.debug_info.last_answer_content ? `<div><strong>æœ€åanswerå†…å®¹:</strong> ${data.debug_info.last_answer_content.substring(0, 100)}...</div>` : ''}
                                    </div>
                                </details>
                            `;
                            analysisElement.appendChild(debugDiv);
                        }
                        
                        resultContent.classList.remove('hidden');
                    } else {
                        errorMessage.innerHTML = `
                            <div class="text-red-600 font-medium mb-3">ç³»ç»Ÿè¿”å›æ ¼å¼å¼‚å¸¸</div>
                            <div class="mt-4 p-4 bg-gray-50 border rounded">
                                <h5 class="font-medium mb-2">åŸå§‹è¿”å›æ•°æ®:</h5>
                                <pre class="text-xs overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        `;
                        errorMessage.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    loadingIndicator.classList.add('hidden');
                    assessBtn.disabled = false;
                    assessBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    errorMessage.textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
                    errorMessage.classList.remove('hidden');
                    console.error('Error:', error);
                });
            });
        });
    </script>
</body>
</html>