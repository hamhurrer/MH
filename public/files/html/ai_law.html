<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³•å¾‹åŠ©æ‰‹ - å®¶äº‹æ³•å¾‹å’¨è¯¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1D4ED8',
                        secondary: '#3B82F6',
                        neutral: '#1E293B',
                        light: '#F8FAFC',
                        accent: '#93C5FD',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .chat-height {
                height: calc(100vh - 12rem);
            }
            .user-message {
                @apply bg-primary text-white rounded-t-lg rounded-br-lg p-4 shadow-md;
            }
            .bot-message {
                @apply bg-light text-neutral rounded-t-lg rounded-bl-lg p-4 shadow-md border border-gray-100;
            }
            .message-container {
                @apply flex items-start mb-4 max-w-3xl;
            }
            .typing-indicator {
                @apply inline-block h-2 w-2 rounded-full bg-primary/70 animate-pulse;
            }
            .legal-tag {
                @apply inline-block px-2 py-1 text-xs font-semibold rounded-full mr-2 mb-2;
            }
            .legal-tag-domestic {
                @apply bg-danger/10 text-danger border border-danger/30;
            }
            .legal-tag-divorce {
                @apply bg-warning/10 text-warning border border-warning/30;
            }
            .legal-tag-property {
                @apply bg-secondary/10 text-secondary border border-secondary/30;
            }
            .legal-tag-child {
                @apply bg-success/10 text-success border border-success/30;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-[#fdfcfb] to-[#e2d1c3] min-h-screen"> 
    <div class="fixed top-4 left-4 z-10">
        <button onclick="goToDesktop()" class="bg-white hover:bg-gray-50 text-neutral/70 hover:text-neutral rounded-full p-3 shadow-lg transition-all duration-200 group">
            <i class="fa fa-home text-lg"></i>
            <span class="absolute left-full ml-2 top-1/2 transform -translate-y-1/2 bg-neutral text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">è¿”å›æ¡Œé¢</span>
        </button>
    </div> 
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-gray-700 font-bold text-[clamp(1.8rem,5vw,2.5rem)] mb-2">æ³•å¾‹åŠ©æ‰‹</h1>
            <p class="text-neutral/70 max-w-2xl mx-auto">ä¸“ä¸šå®¶äº‹æ³•å¾‹å’¨è¯¢ - å®¶æš´ã€ç¦»å©šã€è´¢äº§åˆ†å‰²ã€å­å¥³æŠšå…»ç­‰æ³•å¾‹é—®é¢˜è§£ç­”</p>
            
            <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
            <div class="mt-3 mb-4">
                <div class="inline-flex items-center bg-white rounded-full px-4 py-2 shadow-sm">
                    <svg class="w-4 h-4 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span id="current-user-display" class="text-sm text-neutral/80">æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...</span>
                    <button onclick="clearCurrentUserChat()" class="ml-3 text-xs text-danger hover:text-danger/80 transition-colors">
                        æ¸…é™¤è®°å½•
                    </button>
                </div>
            </div>
            
            <div class="mt-4 flex flex-wrap justify-center">
                <span class="legal-tag legal-tag-domestic">å®¶åº­æš´åŠ›</span>
                <span class="legal-tag legal-tag-divorce">ç¦»å©šè¯‰è®¼</span>
                <span class="legal-tag legal-tag-property">è´¢äº§åˆ†å‰²</span>
                <span class="legal-tag legal-tag-child">å­å¥³æŠšå…»</span>
                <span class="legal-tag">å©šå§»è´¢äº§</span>
                <span class="legal-tag">æŠšå…»æƒ</span>
                <span class="legal-tag">èµ”å¿è®¡ç®—</span>
            </div>
        </header>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div id="chat-messages" class="chat-height overflow-y-auto p-6 space-y-6 bg-gradient-to-br from-[#e2d1c3] to-[#fdfcfb] opacity-80">
                <div class="message-container justify-start">
                    <div class="bot-message">
                        <p>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ³•å¾‹åŠ©æ‰‹ï¼Œä¸“æ³¨äºå®¶äº‹æ³•å¾‹å’¨è¯¢ã€‚</p>
                        <p class="mt-2 text-sm text-neutral/60">æˆ‘å¯ä»¥ä¸ºæ‚¨è§£ç­”å…³äºå®¶åº­æš´åŠ›ã€ç¦»å©šè¯‰è®¼ã€è´¢äº§åˆ†å‰²ã€å­å¥³æŠšå…»ç­‰æ³•å¾‹é—®é¢˜ã€‚è¯·æè¿°æ‚¨çš„å…·ä½“æƒ…å†µæˆ–é—®é¢˜ã€‚</p>
                        <div class="mt-4">
                            <p class="font-medium text-neutral/80">å¸¸è§é—®é¢˜ç¤ºä¾‹ï¼š</p>
                            <ul class="list-disc pl-5 mt-2 text-sm text-neutral/60">
                                <li>é­é‡å®¶åº­æš´åŠ›å¦‚ä½•ç”³è¯·äººèº«ä¿æŠ¤ä»¤ï¼Ÿ</li>
                                <li>å¯¹æ–¹å‡ºè½¨ç¦»å©šï¼Œè´¢äº§å¦‚ä½•åˆ†å‰²ï¼Ÿ</li>
                                <li>å¦‚ä½•äº‰å–å­å¥³çš„æŠšå…»æƒï¼Ÿ</li>
                                <li>ç¦»å©šåå¯¹æ–¹ä¸æ”¯ä»˜æŠšå…»è´¹æ€ä¹ˆåŠï¼Ÿ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200"></div>

            <div class="p-4 bg-white">
                <form id="message-form" class="flex items-center gap-3">
                    <textarea 
                        id="user-input" 
                        placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„æ³•å¾‹é—®é¢˜..." 
                        class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none h-20 transition-all"
                        rows="1"></textarea>
                    <button 
                        type="submit" 
                        class="bg-primary hover:bg-primary/90 text-white rounded-lg p-3 transition-all flex items-center justify-center min-w-[60px]"
                    >
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <div class="mt-8 bg-white rounded-2xl shadow-md p-6">
            <h2 class="text-xl font-semibold text-neutral mb-4">æ³•å¾‹å’¨è¯¢æ³¨æ„äº‹é¡¹</h2>
            <div class="space-y-4 text-neutral/70 text-sm">
                <div class="flex">
                    <div class="shrink-0 mt-1">
                        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="font-medium">å’¨è¯¢å†…å®¹ä¿å¯†</p>
                        <p>æ‚¨çš„å’¨è¯¢å†…å®¹å°†ä¸¥æ ¼ä¿å¯†ï¼Œä»…ç”¨äºä¸ºæ‚¨æä¾›æ³•å¾‹å»ºè®®ã€‚</p>
                    </div>
                </div>
                <div class="flex">
                    <div class="shrink-0 mt-1">
                        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="font-medium">æä¾›è¯¦ç»†ä¿¡æ¯</p>
                        <p>ä¸ºäº†è·å¾—æ›´å‡†ç¡®çš„å»ºè®®ï¼Œè¯·æä¾›å°½å¯èƒ½è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¦‚æ—¶é—´ã€åœ°ç‚¹ã€æ¶‰åŠäººå‘˜ç­‰ã€‚</p>
                    </div>
                </div>
                <div class="flex">
                    <div class="shrink-0 mt-1">
                        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="font-medium">éç´§æ€¥æƒ…å†µ</p>
                        <p>æœ¬æœåŠ¡ä¸æä¾›ç´§æ€¥æ³•å¾‹æ´åŠ©ï¼Œå¦‚é‡ç´§æ€¥æƒ…å†µè¯·ç«‹å³è”ç³»å½“åœ°å…¬å®‰æœºå…³æˆ–å¾‹å¸ˆã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-neutral/50 text-sm">
            <p>Â© 2025 æ³•å¾‹åŠ©æ‰‹ | ä¸“ä¸šå®¶äº‹æ³•å¾‹å’¨è¯¢å¹³å°</p>
        </footer>
    </div>

<script>
window.goToDesktop = function() {

        // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œå°è¯•è·³è½¬åˆ°å¯èƒ½çš„æ¡Œé¢é¡µé¢
        window.location.href = "law.html";

};
// å…¨å±€å˜é‡
let currentUserId = null;
let currentUsername = null;
let chatMessages = null;
let userChatHistory = {}; // å­˜å‚¨å„ç”¨æˆ·çš„èŠå¤©è®°å½•

// APIé…ç½®
const API_URL = 'https://api.coze.cn/v3/chat';
const BOT_ID = '7490080029876125730'; 
const API_KEY = 'pat_lLCLYI0yYq4zQKtP3FfSCuWMbvL0zkbsi8iRTXJiDgwqnB0mWg8coEjvulcSSxic';

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆå‚è€ƒposts.jsçš„æ–¹å¼ï¼‰
async function getCurrentUser() {
    try {
        // æ ¹æ®æ‚¨çš„å®é™…APIè°ƒæ•´
        const response = await fetch('../php/post_api.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=get_current_user'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.status === 'success') {
                currentUserId = result.user_id;
                currentUsername = result.username || `ç”¨æˆ·${currentUserId}`;
                updateUserDisplay();
                return true;
            }
        }
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
    
    // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ·ID
    currentUserId = 'default_user';
    currentUsername = 'è®¿å®¢ç”¨æˆ·';
    updateUserDisplay();
    return false;
}

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
function updateUserDisplay() {
    const userDisplay = document.getElementById('current-user-display');
    if (userDisplay) {
        if (currentUsername) {
            userDisplay.textContent = `å½“å‰ç”¨æˆ·: ${currentUsername}`;
        } else {
            userDisplay.textContent = 'æœªç™»å½•ç”¨æˆ·';
        }
    }
}

// ä¿å­˜èŠå¤©è®°å½•åˆ°localStorageï¼ˆæŒ‰ç”¨æˆ·éš”ç¦»ï¼‰
function saveChatHistory() {
    if (!currentUserId || !chatMessages) return;
    
    const messages = [];
    const messageElements = chatMessages.querySelectorAll('.message-container');
    
    messageElements.forEach(element => {
        const isUser = element.querySelector('.user-message');
        const contentElement = element.querySelector('.message-content');
        
        if (contentElement && contentElement.textContent) {
            messages.push({
                role: isUser ? 'user' : 'bot',
                content: contentElement.textContent.trim(),
                timestamp: Date.now()
            });
        }
    });
    
    // å°†æ¶ˆæ¯å­˜å‚¨åˆ°localStorage
    try {
        localStorage.setItem(`chatHistory_${currentUserId}`, JSON.stringify(messages));
    } catch (e) {
        console.error('ä¿å­˜èŠå¤©è®°å½•åˆ°localStorageå¤±è´¥:', e);
    }
}

// åŠ è½½ç”¨æˆ·çš„èŠå¤©è®°å½•
function loadChatHistory() {
    if (!currentUserId || !chatMessages) return;
    
    try {
        const history = localStorage.getItem(`chatHistory_${currentUserId}`);
        if (!history) return;
        
        const messages = JSON.parse(history);
        if (!Array.isArray(messages)) return;
        
        // æ¸…ç©ºå½“å‰æ˜¾ç¤ºï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
        const welcomeMessage = chatMessages.querySelector('.message-container');
        chatMessages.innerHTML = '';
        if (welcomeMessage) {
            chatMessages.appendChild(welcomeMessage);
        }
        
        // åŠ è½½è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
        messages.forEach(message => {
            if (message.role && message.content && message.role !== 'welcome') {
                addMessageToChat(message.role, message.content, false);
            }
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
    } catch (error) {
        console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
    }
}

// åˆ›å»ºæ¶ˆæ¯å®¹å™¨
function createMessageContainer(role) {
    const div = document.createElement('div');
    div.className = `message-container justify-${role === 'user' ? 'end' : 'start'} mb-4`;
    
    const messageClass = role === 'user' ? 'user-message' : 'bot-message';
    const maxWidth = 'max-w-[85%]';
    
    div.innerHTML = `
        <div class="${messageClass} p-4 rounded-lg shadow-md w-full ${maxWidth}">
            <div class="message-content"></div>
        </div>
    `;
    return div;
}

// æ·»åŠ ç”¨æˆ·/æœºå™¨äººæ¶ˆæ¯
function addMessageToChat(role, content, shouldSave = true) {
    if (!chatMessages) return;
    
    const div = createMessageContainer(role);
    const messageContent = div.querySelector('.message-content');
    
    if (messageContent) {
        messageContent.innerHTML = content
            .split('\n')
            .map(p => `<p>${p}</p>`)
            .join('');
    }
    
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ä¿å­˜èŠå¤©è®°å½•ï¼Œä½¿ç”¨å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
    if (shouldSave) {
        setTimeout(() => {
            saveChatHistory();
        }, 50);
    }
}

// è§£æSSEæ¶ˆæ¯
function parseSseMessage(msg) {
    const lines = msg.split('\n').filter(line => line.trim() !== '');
    let event = null;
    let data = {};
    for (const line of lines) {
        if (line.startsWith('event:')) {
            event = line.substring(6).trim();
        } else if (line.startsWith('data:')) {
            const dataStr = line.substring(5).trim();
            try {
                if (dataStr.startsWith('{') || dataStr.startsWith('[')) {
                    data = JSON.parse(dataStr);
                } else {
                    data = dataStr;
                }
            } catch (error) {
                console.error('è§£ææ•°æ®JSONå¤±è´¥:', error);
                data = dataStr;
            }
        }
    }
    
    return { event, data };
}

// å®æ—¶æ›´æ–°æµå¼æ˜¾ç¤º
function updateStreamDisplay(container, content) {
    let formattedContent = content;
    
    // æ³•å¾‹æ¡æ¬¾é«˜äº®
    const lawPatterns = [
        { pattern: /å©šå§»æ³•ç¬¬\d+æ¡/g, class: 'text-primary font-medium' },
        { pattern: /æ°‘æ³•å…¸ç¬¬\d+æ¡/g, class: 'text-primary font-medium' },
        { pattern: /åˆ‘æ³•ç¬¬\d+æ¡/g, class: 'text-danger font-medium' },
        { pattern: /åå®¶åº­æš´åŠ›æ³•ç¬¬\d+æ¡/g, class: 'text-danger font-medium' }
    ];
    
    lawPatterns.forEach(({ pattern, class: className }) => {
        formattedContent = formattedContent.replace(
            pattern,
            match => `<span class="${className}">${match}</span>`
        );
    });
    
    // æ³•å¾‹æ ‡ç­¾
    const tagPatterns = [
        { pattern: /å®¶åº­æš´åŠ›/g, tag: 'legal-tag-domestic' },
        { pattern: /ç¦»å©š/g, tag: 'legal-tag-divorce' },
        { pattern: /è´¢äº§åˆ†å‰²/g, tag: 'legal-tag-property' },
        { pattern: /å­å¥³æŠšå…»/g, tag: 'legal-tag-child' },
        { pattern: /æŠšå…»æƒ/g, tag: 'legal-tag-child' },
        { pattern: /æŠšå…»è´¹/g, tag: 'legal-tag-child' },
        { pattern: /èµ”å¿/g, tag: 'legal-tag-domestic' }
    ];
    
    tagPatterns.forEach(({ pattern, tag }) => {
        formattedContent = formattedContent.replace(
            pattern,
            match => `<span class="${tag}">${match}</span>`
        );
    });
    
    container.innerHTML = formattedContent
        .split('\n')
        .map(p => {
            if (/^\d+\./.test(p.trim())) {
                return `<p class="mb-2 pl-4 relative">
                    <span class="absolute left-0 text-primary">â€¢</span>${p}
                </p>`;
            }
            return `<p>${p}</p>`;
        })
        .join('');
    
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// å¤„ç†æµå¼æ¶ˆæ¯
async function handleStreamResponse(response, container) {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullContent = '';
    let isCompleted = false;
    let lastAnswerContent = '';

    // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
    container.innerHTML = `
        <div class="flex items-center mb-4">
            <div class="typing-indicator-container">
                <span class="typing-indicator mr-1"></span>
                <span class="typing-indicator mx-1"></span>
                <span class="typing-indicator ml-1"></span>
            </div>
            <span class="ml-2 text-neutral/60">æ­£åœ¨åˆ†ææ³•å¾‹é—®é¢˜...</span>
        </div>
    `;

    try {
        while (!isCompleted) {
            const { done, value } = await reader.read();
            if (done) {
                isCompleted = true;
                break;
            }

            const chunk = decoder.decode(value, { stream: true });
            const messages = chunk.split('\n\n').filter(m => m.trim());

            for (const msg of messages) {
                if (msg.trim() === '') continue;
                
                const { event, data } = parseSseMessage(msg);
                
                if (event === 'conversation.message.stream') {
                    if (typeof data === 'string') {
                        fullContent += data;
                    } else if (data.delta) {
                        fullContent += data.delta;
                    }
                    
                    updateStreamDisplay(container, fullContent);
                } else if (event === 'conversation.message.completed') {
                    if (typeof data === 'string') {
                        try {
                            const parsedData = JSON.parse(data);
                            if (parsedData.type === 'answer') {
                                lastAnswerContent = parsedData.content || '';
                            }
                        } catch (e) {
                            console.error('è§£æå®Œæˆäº‹ä»¶æ•°æ®å¤±è´¥:', e);
                        }
                    } else if (data.type === 'answer') {
                        lastAnswerContent = data.content || '';
                    }
                }
            }
        }
    } catch (error) {
        console.error('å¤„ç†æµå¼å“åº”æ—¶å‡ºé”™:', error);
        isCompleted = true;
    }

    if (lastAnswerContent) {
        fullContent = lastAnswerContent;
        updateStreamDisplay(container, fullContent);
    }

    // ç§»é™¤æ€è€ƒçŠ¶æ€
    container.querySelectorAll('.typing-indicator-container').forEach(el => el.remove());
    if (!fullContent) {
        container.textContent = 'æŠ±æ­‰ï¼Œæœªè·å–åˆ°å›å¤ã€‚';
    }
    
    // ç¡®ä¿å†…å®¹å·²ç»æ›´æ–°åå†ä¿å­˜èŠå¤©è®°å½•
    setTimeout(() => {
        saveChatHistory();
    }, 100);
}

// å…¨å±€æ¸…é™¤å½“å‰ç”¨æˆ·èŠå¤©è®°å½•å‡½æ•°
window.clearCurrentUserChat = function() {
    if (!currentUserId) {
        alert('ç”¨æˆ·ä¿¡æ¯æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }
    
    if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        // æ¸…é™¤è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
        try {
            localStorage.removeItem(`chatHistory_${currentUserId}`);
        } catch (e) {
            console.error('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥:', e);
        }
        
        // é‡ç½®èŠå¤©ç•Œé¢ï¼Œåªä¿ç•™æ¬¢è¿æ¶ˆæ¯
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="message-container justify-start">
                    <div class="bot-message">
                        <p>ğŸ‘‹ ${currentUsername}ï¼Œæ¬¢è¿ä½¿ç”¨æ³•å¾‹åŠ©æ‰‹ï¼æˆ‘ä¸“æ³¨äºå®¶äº‹æ³•å¾‹å’¨è¯¢ã€‚</p>
                        <p class="mt-2 text-sm text-neutral/60">æˆ‘å¯ä»¥ä¸ºæ‚¨è§£ç­”å…³äºå®¶åº­æš´åŠ›ã€ç¦»å©šè¯‰è®¼ã€è´¢äº§åˆ†å‰²ã€å­å¥³æŠšå…»ç­‰æ³•å¾‹é—®é¢˜ã€‚è¯·æè¿°æ‚¨çš„å…·ä½“æƒ…å†µæˆ–é—®é¢˜ã€‚</p>
                        <div class="mt-4">
                            <p class="font-medium text-neutral/80">å¸¸è§é—®é¢˜ç¤ºä¾‹ï¼š</p>
                            <ul class="list-disc pl-5 mt-2 text-sm text-neutral/60">
                                <li>é­é‡å®¶åº­æš´åŠ›å¦‚ä½•ç”³è¯·äººèº«ä¿æŠ¤ä»¤ï¼Ÿ</li>
                                <li>å¯¹æ–¹å‡ºè½¨ç¦»å©šï¼Œè´¢äº§å¦‚ä½•åˆ†å‰²ï¼Ÿ</li>
                                <li>å¦‚ä½•äº‰å–å­å¥³çš„æŠšå…»æƒï¼Ÿ</li>
                                <li>ç¦»å©šåå¯¹æ–¹ä¸æ”¯ä»˜æŠšå…»è´¹æ€ä¹ˆåŠï¼Ÿ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
    }
};

document.addEventListener('DOMContentLoaded', async () => {
    const messageForm = document.getElementById('message-form');
    const userInput = document.getElementById('user-input');
    chatMessages = document.getElementById('chat-messages');
    
    // é¦–å…ˆè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    await getCurrentUser();
    
    // åŠ è½½è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
    loadChatHistory();
    
    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯æ˜¾ç¤ºç”¨æˆ·å
    const welcomeMessage = chatMessages.querySelector('.bot-message p');
    if (welcomeMessage && currentUsername) {
        welcomeMessage.textContent = `ğŸ‘‹ ${currentUsername}ï¼Œæ¬¢è¿ä½¿ç”¨æ³•å¾‹åŠ©æ‰‹ï¼æˆ‘ä¸“æ³¨äºå®¶äº‹æ³•å¾‹å’¨è¯¢ã€‚`;
    }

    // ä¿®æ”¹å‘é€APIè¯·æ±‚çš„éƒ¨åˆ†ï¼Œç¡®ä¿user_idæ ¼å¼æ­£ç¡®
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addMessageToChat('user', message);
        userInput.value = '';

        // åˆ›å»ºæœºå™¨äººæ¶ˆæ¯å®¹å™¨
        const botMessageDiv = createMessageContainer('bot');
        const botResponseContainer = botMessageDiv.querySelector('.message-content');
        chatMessages.appendChild(botMessageDiv);

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bot_id: BOT_ID,
                    // ç¡®ä¿user_idæ˜¯å­—ç¬¦ä¸²æ ¼å¼ä¸”éç©º
                    user_id: currentUserId ? currentUserId.toString() : 'default_user',
                    stream: true,
                    auto_save_history: true,
                    additional_messages: [{
                        role: 'user',
                        content: message,
                        content_type: 'text'
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`APIé”™è¯¯: ${response.status} - ${response.statusText}`);
            }

            // å¤„ç†æµå¼å“åº”
            await handleStreamResponse(response, botResponseContainer);

        } catch (error) {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            botResponseContainer.innerHTML = `
                <div class="p-2 rounded bg-danger/10 text-danger text-sm mb-2">
                    <i class="fa fa-exclamation-circle mr-1"></i> æŠ±æ­‰ï¼Œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯ï¼š${error.message}
                </div>
                <p>æ‚¨ä¹Ÿå¯ä»¥å°è¯•é‡æ–°æè¿°æ‚¨çš„é—®é¢˜ã€‚</p>
            `;
            // å³ä½¿å‡ºé”™ä¹Ÿè¦ä¿å­˜èŠå¤©è®°å½•
            setTimeout(() => {
                saveChatHistory();
            }, 100);
        }
    });

    // æ”¯æŒEnteré”®å‘é€æ¶ˆæ¯
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
</body>
</html>